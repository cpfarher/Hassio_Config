'use strict';

var FCM = require('fcm-push');

module.exports = function (RED) {
  RED.nodes.registerType('fcm-push', function (config) {
    var _this = this;

    RED.nodes.createNode(this, config);
    var serverKey = process.env.FCM_SERVER_KEY;
    try {
      var fcm = new FCM(serverKey);

      this.on('input', function (msg) {
        var message = {
          to: msg.payload.to,
          collapse_key: msg.payload.collapseKey,
          notification: msg.payload.notification
        };

        if (msg.payload.data) message.data = msg.payload.data;

        fcm.send(message).then(function (response) {
          msg.payload = response;
          _this.send(msg);
        }).catch(function (err) {
          msg.error = err;
          _this.error("Couldnt send message", msg);
        });
      });
    } catch (err) {
      this.status({ fill: "red", shape: "ring", text: err.description });
    }
  });
};